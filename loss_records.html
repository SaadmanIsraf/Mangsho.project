<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meat Loss Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #f1f5f9; /* slate-100, a neutral light gray */
        }

        /* Enhanced focus states for better accessibility */
        input:focus, button:focus, canvas:focus, select:focus, textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            /* Using a consistent blue focus ring for this page, can be changed to orange if theme unification is desired */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Tailwind blue-500 focus ring */
        }
        input:focus, select:focus, textarea:focus {
             border-color: #3b82f6; /* blue-500 */
        }

        /* Table Styles */
        th {
            background-color: #eef2ff; /* indigo-50 */
            padding: 0.85rem 1rem; text-align: left; font-weight: 600;
            white-space: nowrap; color: #3730a3; /* indigo-800 */
            font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;
            border-bottom: 2px solid #c7d2fe; /* indigo-200 */
        }
        td {
            padding: 0.85rem 1rem; border-bottom-width: 1px; border-color: #e0e7ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
        }
        tbody tr:nth-child(odd) { background-color: #ffffff; }
        tbody tr:nth-child(even) { background-color: #f5f3ff; } /* violet-50, a very light purple/blue */
        tbody tr { transition: background-color 0.15s ease-in-out; }
        tbody tr:hover { background-color: #e0e7ff; } /* indigo-100 */

        /* Input fields and select */
        input[type="number"], input[type="date"], input[type="file"], input[type="text"], select, textarea {
            border-color: #c7d2fe; /* indigo-200 */
            border-width: 1px; border-radius: 0.375rem; padding: 0.6rem 0.85rem; /* Adjusted padding */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            background-color: #fff; /* Ensure white background for inputs */
        }
        /* Custom style for file input button */
        input[type="file"]::file-selector-button {
            margin-right: 0.75rem; padding: 0.6rem 1rem; border: 1px solid transparent;
            border-radius: 0.375rem; background-color: #e0e7ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
            font-weight: 500; cursor: pointer; transition: background-color 0.15s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover { background-color: #c7d2fe; } /* indigo-200 */

        /* Action Buttons */
        .action-button {
             padding: 0.6rem 1.2rem; /* Adjusted padding */
             border-radius: 0.5rem; /* Slightly more rounded */
             font-size: 0.9rem; font-weight: 500;
             transition: all 0.15s ease-in-out;
             cursor: pointer; border: 1px solid transparent;
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
             display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .action-button:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
             filter: brightness(1.05);
        }
        .action-button:active { transform: translateY(0px); filter: brightness(0.95); }
        .action-button:disabled { cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .action-button svg { width: 1.125rem; height: 1.125rem; }

        /* Specific button colors for this page's theme */
        .button-theme-primary { background-color: #4f46e5; color: white; } /* indigo-600 */
        .button-theme-primary:hover { background-color: #4338ca; } /* indigo-700 */
        .button-theme-secondary { background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe; } /* indigo-100, text-indigo-700, border-indigo-200 */
        .button-theme-secondary:hover { background-color: #c7d2fe; }
        .button-theme-danger { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; } /* red-100, text-red-700, border-red-200 */
        .button-theme-danger:hover { background-color: #fecaca; color: #991b1b; }
        .button-theme-success { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; } /* green-100, text-green-700, border-green-200 */
        .button-theme-success:hover { background-color: #bbf7d0; }


        /* Message Banner Styling (Success/Error) - Consistent with other pages */
        .message-banner {
            border-left-width: 4px; padding: 1rem 1.5rem; margin-bottom: 1.5rem;
            border-radius: 0.375rem; font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: none;
        }
        .message-banner strong { font-weight: 600; } /* Use font-weight instead of <strong> */
        .message-banner span { display: block; sm:inline; margin-left: 0.5rem; }
        .message-banner-success { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .message-banner-error { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Chart container */
        .chart-container { position: relative; margin: auto; height: 350px; width: 100%; max-width: 600px; }
        /* Section Titles */
        .section-title {
             font-size: 1.5rem; /* text-2xl */
             font-weight: 600; color: #1e293b; /* gray-800 */
             margin-bottom: 1.5rem; padding-bottom: 0.75rem;
             border-bottom: 1px solid #d1d5db; /* gray-300 */
        }
        .sub-heading {
            font-size: 1.25rem; font-weight: 600; color: #374151; /* gray-700 */
            margin-bottom: 1rem;
        }
        /* Placeholder text */
        .placeholder-text { color: #6b7280; font-style: italic; text-align: center; padding: 1rem; }
        /* Main container styling */
        .main-container {
            max-width: 7xl; margin-left: auto; margin-right: auto;
            background-color: white; padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Loading spinner for buttons */
        .spinner {
            animation: spin 1s linear infinite; display: inline-block;
            width: 1em; height: 1em;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; margin-right: 0.5em;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="main-container">
        <h1 class="text-3xl md:text-4xl font-bold mb-8 text-gray-800 text-center">Meat Loss Recorder</h1>

        <div id="success-message-banner" class="message-banner message-banner-success">
            <strong class="font-bold">Success!</strong>
            <span id="success-text"></span>
        </div>
        <div id="error-message-banner" class="message-banner message-banner-error">
            <strong class="font-bold">Error!</strong>
            <span id="error-text"></span>
        </div>


        <section id="record-entry" class="mb-10 border-b border-gray-200 pb-10">
            <form id="lossForm" class="space-y-5">
                <h2 class="sub-heading">Record Single Loss Entry</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div>
                        <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-1">Date of Loss</label>
                        <input type="date" id="recordDate" name="recordDate" required>
                    </div>
                    <div>
                        <label for="meatType" class="block text-sm font-medium text-gray-700 mb-1">Meat Type</label>
                        <select id="meatType" name="meatType" required>
                            <option value="" disabled selected>Select Meat Type</option>
                            <option value="Chicken">Chicken</option>
                            <option value="Beef">Beef</option>
                            <option value="Mutton">Mutton</option>
                            <option value="Pork">Pork</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                     <div>
                        <label for="stage" class="block text-sm font-medium text-gray-700 mb-1">Stage of Loss</label>
                        <select id="stage" name="stage" required>
                            <option value="" disabled selected>Select Stage</option>
                            <option value="Receiving">Receiving</option>
                            <option value="Slaughter">Slaughter</option>
                            <option value="Processing">Processing</option>
                            <option value="Packaging">Packaging</option>
                            <option value="Storage">Storage</option>
                            <option value="Handling">Handling</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Retail">Retail</option>
                            <option value="Expired">Expired</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Contamination">Contamination</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                     <div>
                        <label for="wastageAmount" class="block text-sm font-medium text-gray-700 mb-1">Wastage Amount (kg)</label>
                        <input type="number" id="wastageAmount" name="wastageAmount" min="0.01" step="0.01" required placeholder="e.g., 1.5">
                    </div>
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea id="notes" name="notes" rows="1" placeholder="Reason, temperature, condition, etc." class="align-top" style="min-height: 42px;"></textarea>
                    </div>
                </div>
                <div class="text-center pt-4">
                    <button type="submit" class="action-button button-theme-primary" id="recordLossButton">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-add w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        <span class="button-text">Record Loss</span>
                    </button>
                </div>
            </form>
        </section>

        <section id="excel-import" class="mb-10 border-b border-gray-200 pb-10">
             <h2 class="sub-heading">Import Losses from Excel</h2>
             <p class="text-sm text-gray-600 mb-4">
                 Upload an Excel file (.xlsx, .xls) with columns (case-insensitive):
                 <code class="text-xs bg-gray-100 p-1 rounded">Date</code>,
                 <code class="text-xs bg-gray-100 p-1 rounded">Meat Type</code>,
                 <code class="text-xs bg-gray-100 p-1 rounded">Stage</code>,
                 <code class="text-xs bg-gray-100 p-1 rounded">Wastage Amount</code> (or `Wastage Amount (kg)`),
                 <code class="text-xs bg-gray-100 p-1 rounded">Notes</code> (optional).
                 <br>Dates should be in YYYY-MM-DD format or a common Excel date format.
             </p>
             <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                 <input type="file" id="excelFile" accept=".xlsx, .xls" class="flex-grow w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer">
                 <button id="importButton" disabled class="action-button button-theme-success w-full sm:w-auto">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-import w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                     <span class="button-text">Import Data</span>
                 </button>
             </div>
             <p id="file-name-display" class="mt-3 text-sm text-gray-500 italic"></p>
        </section>

        <section id="analysis-charts" class="mb-10 border-b border-gray-200 pb-10">
             <h2 class="section-title">Loss Analysis & Visualization</h2>
             <div class="mb-6 text-center">
                 <button id="analyzeButton" class="action-button button-theme-primary">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg>
                     Analyze All Losses
                 </button>
             </div>
             <div id="analysisResult" class="mb-8 p-4 bg-gray-50 rounded-md border border-gray-200 text-sm text-gray-700 min-h-[50px]">
                 Click the "Analyze All Losses" button to see the summary and charts based on *all* recorded data in local storage.
             </div>
             <div id="chartsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6" style="display: none;">
                 <div>
                     <h3 class="sub-heading text-center">Wastage by Stage</h3>
                     <div class="chart-container"><canvas id="stageChart"></canvas></div>
                 </div>
                 <div>
                     <h3 class="sub-heading text-center">Wastage by Meat Type</h3>
                     <div class="chart-container"><canvas id="meatTypeChart"></canvas></div>
                 </div>
             </div>
        </section>

        <section id="recorded-losses" class="mb-8">
            <h2 class="section-title">Recorded Losses</h2>

            <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <label for="searchInput" class="block text-sm font-medium text-indigo-700 mb-1">Search Records</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="searchInput" placeholder="Search by Meat Type, Stage, or Notes..." class="flex-grow">
                    <button id="searchButtonEl" class="action-button button-theme-secondary">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                         Search
                    </button>
                    <button id="clearSearchButton" class="action-button button-theme-secondary">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                         Clear
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg shadow border border-gray-200 bg-white">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Meat Type</th>
                            <th>Stage</th>
                            <th class="text-right">Wastage (kg)</th>
                            <th>Notes</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lossTableBody" class="divide-y divide-gray-200">
                        <tr id="no-records-row">
                            <td colspan="6" class="placeholder-text py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                  <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                                </svg>
                                <span class="mt-2 block text-sm font-medium text-gray-500">No records yet</span>
                                <span class="mt-1 block text-sm text-gray-500">Add a record using the form or import from Excel.</span>
                            </td>
                        </tr>
                    </tbody>
                     <tfoot id="tableFooter" class="bg-gray-50 font-semibold">
                     </tfoot>
                </table>
            </div>
        </section>
    </div>

    <script>
        // --- DOM Element References ---
        const lossForm = document.getElementById('lossForm');
        const lossTableBody = document.getElementById('lossTableBody');
        const noRecordsRow = document.getElementById('no-records-row');
        const tableFooter = document.getElementById('tableFooter');
        const recordDateInput = document.getElementById('recordDate');
        const meatTypeSelect = document.getElementById('meatType');
        const stageSelect = document.getElementById('stage');
        const wastageAmountInput = document.getElementById('wastageAmount');
        const notesInput = document.getElementById('notes');
        const recordLossButton = document.getElementById('recordLossButton');

        const excelFileInput = document.getElementById('excelFile');
        const importButton = document.getElementById('importButton');
        const fileNameDisplay = document.getElementById('file-name-display');

        const successMessageBanner = document.getElementById('success-message-banner');
        const successTextEl = document.getElementById('success-text');
        const errorMessageBanner = document.getElementById('error-message-banner');
        const errorTextEl = document.getElementById('error-text');

        const searchInput = document.getElementById('searchInput');
        const searchButtonEl = document.getElementById('searchButtonEl'); // Renamed from previous
        const clearSearchButton = document.getElementById('clearSearchButton');

        const analyzeButton = document.getElementById('analyzeButton');
        const analysisResultDiv = document.getElementById('analysisResult');
        const chartsContainer = document.getElementById('chartsContainer');
        const stageChartCanvas = document.getElementById('stageChart');
        const meatTypeChartCanvas = document.getElementById('meatTypeChart');

        // --- Constants & State ---
        const STORAGE_KEY = 'meatLossRecords_v8_server_integration'; // Updated key
        const API_ADD_LOSS_RECORD_URL = 'php/api_add_loss_record.php';
        // Headers expected from Excel (case-insensitive, common variations)
        const EXPECTED_EXCEL_HEADERS_MAP = {
            'date': 'record_date',
            'meat type': 'meat_type',
            'stage': 'stage',
            'wastage amount (kg)': 'wastage_amount',
            'wastage amount': 'wastage_amount', // Alternative header
            'notes': 'notes'
        };
        const ALLOWED_MEAT_TYPES = ["Chicken", "Beef", "Mutton", "Pork", "Other"];
        const ALLOWED_STAGES = ["Receiving", "Slaughter", "Processing", "Packaging", "Storage", "Handling", "Transportation", "Retail", "Expired", "Damaged", "Contamination", "Other"];

        let allLossRecords = []; // This will primarily be fed from localStorage for now
        let currentSearchTerm = '';
        let stageChartInstance = null;
        let meatTypeChartInstance = null;

        // --- Utility Functions ---
        function displayMessage(element, textElement, message, type = 'error') {
            textElement.innerHTML = message; // Use innerHTML for <br> tags
            element.className = `message-banner message-banner-${type}`;
            element.style.display = 'block';
            scrollToMessage(element);
            if (type === 'success') {
                setTimeout(() => { element.style.display = 'none'; }, 6000);
            }
        }
        function hideAllMessages() {
            successMessageBanner.style.display = 'none';
            errorMessageBanner.style.display = 'none';
        }
        function scrollToMessage(element) {
            const msgRect = element.getBoundingClientRect();
            if (msgRect.top < 0 || msgRect.bottom > window.innerHeight) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        function formatDateForStorage(date) { // Expects YYYY-MM-DD string or Date object
            if (date instanceof Date) return date.toISOString().split('T')[0];
            return date; // Assume already YYYY-MM-DD
        }
         function formatExcelDate(excelDate) { // From inventory.html, robust date parsing
            if (excelDate instanceof Date && !isNaN(excelDate.getTime())) {
                try {
                    const year = excelDate.getFullYear();
                    if (year < 1900 || year > 2100) return excelDate.toLocaleDateString();
                    const month = String(excelDate.getMonth() + 1).padStart(2, '0');
                    const day = String(excelDate.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) { return excelDate.toLocaleDateString(); }
            }
            if (typeof excelDate === 'number' && !isNaN(excelDate) && excelDate >= 1 && excelDate <= 2958465) {
                try {
                    const excelEpoch = Date.UTC(1899, 11, 30);
                    const jsMillis = excelEpoch + excelDate * 86400000;
                    const jsDate = new Date(jsMillis);
                    if (isNaN(jsDate.getTime())) return String(excelDate);
                    const year = jsDate.getUTCFullYear();
                    if (year < 1900 || year > 2100) return String(excelDate);
                    const month = String(jsDate.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(jsDate.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) { return String(excelDate); }
            }
            if (typeof excelDate === 'string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(excelDate)) return excelDate;
            if (typeof excelDate === 'string') {
                try {
                    const d = new Date(excelDate);
                    if (!isNaN(d.getTime())) {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        if (year > 1900 && year < 2100) return `${year}-${month}-${day}`;
                    }
                } catch (e) { /* ignore */ }
            }
            return String(excelDate);
        }


        // --- Local Storage & Data Retrieval ---
        function loadRecordsFromStorage() {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            // Ensure all records have a unique client-side ID if they don't have one from the server
            allLossRecords = records.map((record, index) => ({
                ...record,
                // Use existing 'id' if it's from server, otherwise generate a temp client-side ID
                clientId: record.id || `client-${Date.now()}-${index}`
            })).sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
        }
        function saveRecordsToStorage() {
            // When saving, we might not want to save temporary clientIds if server IDs exist
            const recordsToSave = allLossRecords.map(r => {
                const { clientId, ...record } = r; // Exclude clientId before saving
                return record;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(recordsToSave));
            updateTableFooter();
        }

        // --- Search Logic ---
        function getRecordsToDisplay() {
            if (!currentSearchTerm) return allLossRecords;
            const searchTermLower = currentSearchTerm.toLowerCase();
            return allLossRecords.filter(record =>
                (record.meat_type || '').toLowerCase().includes(searchTermLower) ||
                (record.stage || '').toLowerCase().includes(searchTermLower) ||
                (record.notes || '').toLowerCase().includes(searchTermLower)
            );
        }

        // --- Table Manipulation ---
        function renderTable() {
            const recordsToDisplay = getRecordsToDisplay();
            lossTableBody.innerHTML = ''; // Clear existing rows

            if (recordsToDisplay.length === 0) {
                noRecordsRow.style.display = 'table-row'; // Show the placeholder row
                const messageCell = noRecordsRow.querySelector('td');
                messageCell.innerHTML = `
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    <span class="mt-2 block text-sm font-medium text-gray-500">${currentSearchTerm ? 'No records match your search.' : 'No records yet.'}</span>
                    ${currentSearchTerm ? '' : '<span class="mt-1 block text-sm text-gray-500">Add a record or import from Excel.</span>'}`;
            } else {
                noRecordsRow.style.display = 'none'; // Hide placeholder
                recordsToDisplay.forEach(record => addRecordToTable(record));
            }
            updateTableFooter();
            clearAnalysis(); // Clear analysis whenever table re-renders
        }

        function updateTableFooter() {
            const overallTotal = allLossRecords.reduce((sum, record) => sum + parseFloat(record.wastage_amount || 0), 0);
            tableFooter.innerHTML = ''; // Clear previous footer
            if (allLossRecords.length > 0) {
                const summaryRow = tableFooter.insertRow();
                summaryRow.innerHTML = `
                    <td colspan="3" class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Overall Total Wastage:</td>
                    <td class="px-4 py-3 text-right text-sm font-semibold text-gray-700">${overallTotal.toFixed(2)} kg</td>
                    <td colspan="2" class="px-4 py-3"></td>
                `;
            }
        }

        function addRecordToTable(record) {
            const row = lossTableBody.insertRow();
            // Use clientId for the data-id attribute for client-side operations like delete
            row.setAttribute('data-id', record.clientId);
            row.innerHTML = `
                <td>${record.record_date || 'N/A'}</td>
                <td>${record.meat_type || 'N/A'}</td>
                <td>${record.stage || 'N/A'}</td>
                <td class="text-right">${parseFloat(record.wastage_amount || 0).toFixed(2)}</td>
                <td class="break-words min-w-[150px] max-w-[300px]">${record.notes || '-'}</td>
                <td class="text-center">
                    <button onclick="handleDeleteRecord('${record.clientId}')" class="action-button button-theme-danger px-2 py-1" title="Delete Record">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                    </button>
                </td>
            `;
        }

        function handleDeleteRecord(clientId) {
            if (confirm('Are you sure you want to delete this record? This action only removes it from the local list for now.')) {
                allLossRecords = allLossRecords.filter(record => record.clientId !== clientId);
                saveRecordsToStorage();
                renderTable();
                displayMessage(successMessageBanner, successTextEl, 'Record deleted successfully from local list.', 'success');
                // TODO: Implement backend deletion API call here if record.id (server ID) exists
            }
        }


        // --- Form Handling (Manual Entry) ---
        lossForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            hideAllMessages();

            const submitButton = recordLossButton;
            const buttonTextEl = submitButton.querySelector('.button-text');
            const iconAdd = submitButton.querySelector('.icon-add');
            const originalButtonText = buttonTextEl.textContent;

            submitButton.disabled = true;
            if(iconAdd) iconAdd.style.display = 'none';
            const spinner = document.createElement('span');
            spinner.className = 'spinner';
            buttonTextEl.insertAdjacentElement('beforebegin', spinner);
            buttonTextEl.textContent = 'Recording...';

            const record = {
                record_date: formatDateForStorage(recordDateInput.value),
                meat_type: meatTypeSelect.value,
                stage: stageSelect.value,
                wastage_amount: parseFloat(wastageAmountInput.value),
                notes: notesInput.value.trim()
            };

            // Client-side validation
            let errors = [];
            if (!record.record_date) errors.push('Date is required.');
            if (!record.meat_type) errors.push('Meat Type is required.');
            if (!record.stage) errors.push('Stage is required.');
            if (isNaN(record.wastage_amount) || record.wastage_amount <= 0) {
                errors.push('Wastage Amount must be a positive number.');
            }

            if (errors.length > 0) {
                displayMessage(errorMessageBanner, errorTextEl, errors.join('<br>'), 'error');
                submitButton.disabled = false;
                if(iconAdd) iconAdd.style.display = 'inline-block'; // Or 'block'
                if(spinner.parentNode) spinner.remove();
                buttonTextEl.textContent = originalButtonText;
                return;
            }

            try {
                const response = await fetch(API_ADD_LOSS_RECORD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
                const result = await response.json();

                if (result.success) {
                    displayMessage(successMessageBanner, successTextEl, result.message || 'Loss record added successfully to server.', 'success');
                    // Add to local storage and re-render
                    const newRecordForLocal = {
                        ...record,
                        id: result.record_id, // Use server-generated ID
                        clientId: `client-${Date.now()}` // Still need a unique client ID for local ops if server ID isn't always unique or for immediate use
                    };
                    allLossRecords.unshift(newRecordForLocal); // Add to beginning for newest first
                    allLossRecords.sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
                    saveRecordsToStorage();
                    renderTable();
                    lossForm.reset();
                    recordDateInput.value = new Date().toISOString().split('T')[0]; // Reset date to today
                } else {
                    displayMessage(errorMessageBanner, errorTextEl, result.message || 'Failed to save record to server.', 'error');
                }
            } catch (error) {
                console.error('Error submitting loss record:', error);
                displayMessage(errorMessageBanner, errorTextEl, 'An network or unexpected error occurred: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                if(iconAdd) iconAdd.style.display = 'inline-block'; // Or 'block'
                if(spinner.parentNode) spinner.remove();
                buttonTextEl.textContent = originalButtonText;
            }
        });

        // --- Excel Import Handling ---
        excelFileInput.addEventListener('change', () => {
            importButton.disabled = !excelFileInput.files || excelFileInput.files.length === 0;
            if (excelFileInput.files.length > 0) {
                fileNameDisplay.textContent = `Selected: ${excelFileInput.files[0].name}`;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        importButton.addEventListener('click', async () => {
            if (!excelFileInput.files || excelFileInput.files.length === 0) {
                displayMessage(errorMessageBanner, errorTextEl, 'Please select an Excel file first.', 'error');
                return;
            }
            const file = excelFileInput.files[0];
            hideAllMessages();

            const importButtonTextEl = importButton.querySelector('.button-text');
            const importIcon = importButton.querySelector('.icon-import');
            const originalImportButtonText = importButtonTextEl.textContent;

            importButton.disabled = true;
            if(importIcon) importIcon.style.display = 'none';
            const importSpinner = document.createElement('span');
            importSpinner.className = 'spinner';
            importButtonTextEl.insertAdjacentElement('beforebegin', importSpinner);
            importButtonTextEl.textContent = 'Importing...';

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = event.target.result;
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonDataRaw = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });

                    if (jsonDataRaw.length < 2) { // Header + at least one data row
                        throw new Error("Excel file is empty or has no data rows after the header.");
                    }

                    const headerRow = jsonDataRaw[0].map(h => String(h || '').trim().toLowerCase());
                    const recordsToAddToServer = [];
                    let validationErrors = [];

                    for (let i = 1; i < jsonDataRaw.length; i++) { // Start from 1 to skip header
                        const rowArray = jsonDataRaw[i];
                        const rowNumForError = i + 1;
                        const rowObject = {};
                        let rowHasCriticalError = false;

                        headerRow.forEach((header, index) => {
                            const mappedKey = EXPECTED_EXCEL_HEADERS_MAP[header];
                            if (mappedKey) {
                                rowObject[mappedKey] = rowArray[index];
                            } else if (header === 'wastage amount (kg)' || header === 'wastage amount'){ // common variations
                                rowObject['wastage_amount'] = rowArray[index];
                            }
                        });


                        const record = {
                            record_date: rowObject.record_date ? formatExcelDate(rowObject.record_date) : null,
                            meat_type: String(rowObject.meat_type || '').trim(),
                            stage: String(rowObject.stage || '').trim(),
                            wastage_amount: rowObject.wastage_amount !== null && rowObject.wastage_amount !== '' ? parseFloat(rowObject.wastage_amount) : null,
                            notes: String(rowObject.notes || '').trim()
                        };

                        if (!record.record_date || !/^\d{4}-\d{2}-\d{2}$/.test(record.record_date)) { validationErrors.push(`Row ${rowNumForError}: Invalid or missing Date.`); rowHasCriticalError = true; }
                        if (!record.meat_type || !ALLOWED_MEAT_TYPES.includes(record.meat_type)) { validationErrors.push(`Row ${rowNumForError}: Invalid or missing Meat Type.`); rowHasCriticalError = true; }
                        if (!record.stage || !ALLOWED_STAGES.includes(record.stage)) { validationErrors.push(`Row ${rowNumForError}: Invalid or missing Stage.`); rowHasCriticalError = true; }
                        if (record.wastage_amount === null || isNaN(record.wastage_amount) || record.wastage_amount <= 0) { validationErrors.push(`Row ${rowNumForError}: Wastage Amount must be a positive number.`); rowHasCriticalError = true; }

                        if (!rowHasCriticalError) {
                            recordsToAddToServer.push(record);
                        }
                    }

                    if (validationErrors.length > 0 && recordsToAddToServer.length === 0) { // Only errors, no valid records
                         throw new Error(`No valid records to import. Found errors like: ${validationErrors.slice(0,3).join('; ')}`);
                    }


                    let successfullyAddedCount = 0;
                    let serverErrors = [];

                    for (const record of recordsToAddToServer) {
                        try {
                            const response = await fetch(API_ADD_LOSS_RECORD_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(record)
                            });
                            const result = await response.json();
                            if (result.success) {
                                successfullyAddedCount++;
                                const newRecordForLocal = { ...record, id: result.record_id, clientId: `client-${Date.now()}-${successfullyAddedCount}` };
                                allLossRecords.unshift(newRecordForLocal); // Add to local list
                            } else {
                                serverErrors.push(`Server error for a record (Date: ${record.record_date}): ${result.message || 'Unknown error'}`);
                            }
                        } catch (fetchError) {
                            serverErrors.push(`Network error for a record (Date: ${record.record_date}): ${fetchError.message}`);
                        }
                    }
                    allLossRecords.sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
                    saveRecordsToStorage();
                    renderTable();

                    let finalMessageText = "";
                    if (successfullyAddedCount > 0) {
                        finalMessageText += `Successfully imported and saved ${successfullyAddedCount} records to the server. `;
                    }
                    if (validationErrors.length > 0) {
                        finalMessageText += `\nEncountered ${validationErrors.length} validation issues (these rows were not sent to server):\n- ${validationErrors.slice(0, 3).join('\n- ')}${validationErrors.length > 3 ? '\n... (and more)' : ''}. `;
                    }
                    if (serverErrors.length > 0) {
                        finalMessageText += `\nEncountered ${serverErrors.length} server-side errors during import:\n- ${serverErrors.slice(0, 3).join('\n- ')}${serverErrors.length > 3 ? '\n... (and more)' : ''}. `;
                    }

                    if (finalMessageText) {
                        displayMessage(successfullyAddedCount > 0 && validationErrors.length === 0 && serverErrors.length === 0 ? successMessageBanner : errorMessageBanner,
                                       successfullyAddedCount > 0 && validationErrors.length === 0 && serverErrors.length === 0 ? successTextEl : errorTextEl,
                                       finalMessageText.trim().replace(/\n/g, '<br>'),
                                       successfullyAddedCount > 0 && validationErrors.length === 0 && serverErrors.length === 0 ? 'success' : 'error');
                    } else if (jsonDataRaw.length < 2) { // Handles case where only header exists or empty file
                        displayMessage(errorMessageBanner, errorTextEl, 'No data rows found in the Excel file to import.', 'error');
                    } else {
                         displayMessage(errorMessageBanner, errorTextEl, 'No records were imported. Check file content and console for details.', 'error');
                    }


                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    displayMessage(errorMessageBanner, errorTextEl, `Error processing Excel file: ${error.message}`, 'error');
                } finally {
                    excelFileInput.value = ''; // Reset file input
                    fileNameDisplay.textContent = '';
                    importButton.disabled = true;
                    if(importIcon) importIcon.style.display = 'inline-block';
                    if(importSpinner.parentNode) importSpinner.remove();
                    importButtonTextEl.textContent = originalImportButtonText;
                }
            };
            reader.onerror = (error) => {
                console.error("Error reading file:", error);
                displayMessage(errorMessageBanner, errorTextEl, 'Error reading the selected file.', 'error');
                excelFileInput.value = '';
                fileNameDisplay.textContent = '';
                importButton.disabled = true;
                if(importIcon) importIcon.style.display = 'inline-block';
                if(importSpinner.parentNode) importSpinner.remove();
                importButtonTextEl.textContent = originalImportButtonText;
            };
            reader.readAsArrayBuffer(file);
        });


        // --- Search Button Handlers ---
        searchButtonEl.addEventListener('click', () => {
            currentSearchTerm = searchInput.value.trim();
            renderTable();
        });
        searchInput.addEventListener('keypress', (event) => {
             if (event.key === 'Enter') { event.preventDefault(); searchButtonEl.click(); }
        });
        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            currentSearchTerm = '';
            renderTable();
        });

        // --- Loss Analysis & Charting (Existing Logic - Largely Unchanged) ---
        const lossKeywords = [
            'temperature', 'temp', 'cold chain', 'refrigeration', 'freezer', 'delay', 'time', 'late', 'equipment', 'machine', 'breakdown', 'malfunction', 'handling', 'dropped', 'error', 'procedure', 'improper', 'rough', 'storage', 'shelf life', 'expired', 'date', 'transport', 'truck', 'vehicle', 'cutting', 'trimming', 'yield', 'packaging', 'seal', 'vacuum', 'leak', 'contamination', 'bacteria', 'mold', 'hygiene', 'sanitation', 'power outage', 'failure'
        ];
        function analyzeLosses() {
             const recordsForAnalysis = allLossRecords; // Use current local records
             analysisResultDiv.innerHTML = ''; destroyCharts();
             if (recordsForAnalysis.length === 0) {
                 analysisResultDiv.textContent = 'No records available in local storage to analyze.';
                 chartsContainer.style.display = 'none'; return;
             }
             const overallTotal = recordsForAnalysis.reduce((sum, record) => sum + parseFloat(record.wastage_amount || 0), 0);
             const lossByMeatType = {}; const lossByStage = {}; const keywordCounts = {};
             lossKeywords.forEach(k => keywordCounts[k] = 0);

             recordsForAnalysis.forEach(record => {
                 const wastage = parseFloat(record.wastage_amount || 0);
                 const meatType = record.meat_type || 'Unknown'; const stage = record.stage || 'Unknown';
                 lossByMeatType[meatType] = (lossByMeatType[meatType] || { total: 0, count: 0 });
                 lossByMeatType[meatType].total += wastage; lossByMeatType[meatType].count += 1;
                 lossByStage[stage] = (lossByStage[stage] || { total: 0, count: 0 });
                 lossByStage[stage].total += wastage; lossByStage[stage].count += 1;
                 const notesLower = (record.notes || '').toLowerCase();
                 lossKeywords.forEach(keyword => { if (notesLower.includes(keyword)) keywordCounts[keyword]++; });
             });

             let analysisHTML = `<h3 class="sub-heading mb-3">Analysis Summary (All ${recordsForAnalysis.length} Local Records)</h3>`;
             analysisHTML += `<p class="mb-2"><strong>Total Recorded Wastage (Local):</strong> <strong>${overallTotal.toFixed(2)} kg</strong>.</p>`;
             let maxLossStage = { name: 'N/A', total: -1 }; Object.entries(lossByStage).forEach(([name, data]) => { if (data.total > maxLossStage.total) maxLossStage = { name, total: data.total }; });
             let maxLossType = { name: 'N/A', total: -1 }; Object.entries(lossByMeatType).forEach(([name, data]) => { if (data.total > maxLossType.total) maxLossType = { name, total: data.total }; });
             analysisHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">`;
             analysisHTML += `<div class="bg-red-100 p-3 rounded border border-red-200 text-red-800"><strong>Highest Wastage Stage:</strong> ${maxLossStage.name} (${maxLossStage.total.toFixed(2)} kg)</div>`;
             analysisHTML += `<div class="bg-yellow-100 p-3 rounded border border-yellow-300 text-yellow-800"><strong>Highest Wastage Meat Type:</strong> ${maxLossType.name} (${maxLossType.total.toFixed(2)} kg)</div>`;
             analysisHTML += `</div>`;
             analysisHTML += `<h4 class="text-md font-semibold mb-2 mt-4 text-gray-700">Wastage Breakdown by Stage:</h4><ul>`; const sortedStages = Object.entries(lossByStage).sort(([,a], [,b]) => b.total - a.total); sortedStages.forEach(([stage, data]) => { analysisHTML += `<li><strong>${stage}:</strong> ${data.total.toFixed(2)} kg total wastage from ${data.count} record(s).</li>`; }); analysisHTML += `</ul>`;
             analysisHTML += `<h4 class="text-md font-semibold mb-2 mt-4 text-gray-700">Wastage Breakdown by Meat Type:</h4><ul>`; const sortedTypes = Object.entries(lossByMeatType).sort(([,a], [,b]) => b.total - a.total); sortedTypes.forEach(([type, data]) => { analysisHTML += `<li><strong>${type}:</strong> ${data.total.toFixed(2)} kg total wastage from ${data.count} record(s).</li>`; }); analysisHTML += `</ul>`;
             const significantKeywords = Object.entries(keywordCounts).filter(([, count]) => count > 0).sort(([,a], [,b]) => b - a);
             if (significantKeywords.length > 0) { analysisHTML += `<h4 class="text-md font-semibold mb-2 mt-4 text-gray-700">Potential Contributing Factors (from Notes):</h4><ul>`; significantKeywords.slice(0, 5).forEach(([keyword, count]) => { analysisHTML += `<li><strong>${keyword.charAt(0).toUpperCase() + keyword.slice(1)}:</strong> Mentioned in ${count} record(s).</li>`; }); analysisHTML += `</ul><p class="text-xs italic mt-1 text-gray-500">Note: Keyword analysis based on all local records.</p>`; } else { analysisHTML += `<p class="mt-4 text-gray-600">No common keywords found in notes across local records.</p>`; }
             analysisResultDiv.innerHTML = analysisHTML;
             generateCharts(lossByStage, lossByMeatType);
             chartsContainer.style.display = 'grid';
         }
         function destroyCharts() {
             if (stageChartInstance) { stageChartInstance.destroy(); stageChartInstance = null; }
             if (meatTypeChartInstance) { meatTypeChartInstance.destroy(); meatTypeChartInstance = null; }
         }
        function generateCharts(stageData, typeData) {
            destroyCharts();
            const sortedStageData = Object.entries(stageData).sort(([,a], [,b]) => b.total - a.total);
            const stageLabels = sortedStageData.map(([stage]) => stage);
            const stageWastage = sortedStageData.map(([, data]) => data.total.toFixed(2));

            const sortedTypeData = Object.entries(typeData).sort(([,a], [,b]) => b.total - a.total);
            const typeLabels = sortedTypeData.map(([type]) => type);
            const typeWastage = sortedTypeData.map(([, data]) => data.total.toFixed(2));

            // Theme consistent colors
            const backgroundColors = ['rgba(79, 70, 229, 0.6)', 'rgba(239, 68, 68, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(245, 158, 11, 0.6)', 'rgba(139, 92, 246, 0.6)', 'rgba(249, 115, 22, 0.6)', 'rgba(107, 114, 128, 0.6)'];
            const borderColors = backgroundColors.map(color => color.replace('0.6', '1'));

            const chartOptions = (yLabel) => ({
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: yLabel, font: {weight: '500'} }, grid: { color: '#e0e7ff' }, ticks:{color: '#4338ca'} },
                    x: { grid: { display: false }, ticks:{color: '#4338ca'} }
                },
                plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e2937', titleColor: '#ffffff', bodyColor: '#ffffff', padding: 10, cornerRadius: 4 } }
            });

            if (stageLabels.length > 0) {
                stageChartInstance = new Chart(stageChartCanvas, {
                    type: 'bar',
                    data: { labels: stageLabels, datasets: [{ label: 'Total Wastage (kg)', data: stageWastage, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1, borderRadius: 4 }] },
                    options: chartOptions('Wastage (kg)')
                });
            }

            if (typeLabels.length > 0) {
                meatTypeChartInstance = new Chart(meatTypeChartCanvas, {
                    type: 'bar',
                    data: { labels: typeLabels, datasets: [{ label: 'Total Wastage (kg)', data: typeWastage, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1, borderRadius: 4 }] },
                    options: chartOptions('Wastage (kg)')
                });
            }
         }
         function clearAnalysis() {
             analysisResultDiv.innerHTML = 'Click the "Analyze All Losses" button to see the summary and charts based on *all* recorded data in local storage.';
             destroyCharts();
             chartsContainer.style.display = 'none';
         }
         analyzeButton.addEventListener('click', analyzeLosses);


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            recordDateInput.value = new Date().toISOString().split('T')[0]; // Default to today
            loadRecordsFromStorage();
            renderTable();
            clearAnalysis();
            importButton.disabled = true; // Disable import initially
            hideAllMessages(); // Ensure messages are hidden on load
        });

    </script>

</body>
</html>
